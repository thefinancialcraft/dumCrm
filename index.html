<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Insurance CRM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      -webkit-font-smoothing: antialiased;
    }
    .tab-active { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    .modal { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 50; 
      animation: fadeIn 0.2s ease;
    }
    .modal.active { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
    }
    .modal-content {
      animation: slideUp 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
    }
    .badge { 
      font-size: 0.7rem; 
      padding: 0.3rem 0.65rem; 
      border-radius: 20px; 
      font-weight: 600;
      letter-spacing: 0.3px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
      transform: translateY(-2px);
    }
    .btn-call {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      transition: all 0.3s ease;
    }
    .btn-call:hover {
      box-shadow: 0 8px 16px rgba(16, 185, 129, 0.4);
      transform: translateY(-2px);
    }
    .btn-whatsapp {
      background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
      transition: all 0.3s ease;
    }
    .btn-whatsapp:hover {
      box-shadow: 0 8px 16px rgba(37, 211, 102, 0.4);
      transform: translateY(-2px);
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 1.2em;
      padding-right: 2.5rem;
    }
    select option {
      padding: 0.5rem;
    }
    /* Custom styling for dropdown */
    select::-ms-expand {
      display: none;
    }
    select option:hover {
      background-color: #f3f4f6;
    }
    /* Dropdown list height when opened */
    select:not([multiple]) {
      height: 2.5rem;
    }
    /* Style for option list when opened */
    select option {
      font-size: 0.875rem;
      line-height: 1.25rem;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .chip-filter {
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    .chip-filter:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .chip-active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white !important;
      border-color: #667eea;
    }
    
    /* Mobile-specific modal improvements */
    @media (max-width: 640px) {
      .modal {
        padding: 0.5rem;
      }
      .modal-content {
        border-radius: 1rem;
        margin: 0.5rem;
        max-height: calc(100vh - 1rem);
      }
      
      /* Improve touch targets */
      select, input, button {
        min-height: 44px;
      }
      
      /* Better spacing for mobile */
      .modal .space-y-4 > * + * {
        margin-top: 1rem;
      }
      
      /* Improve dropdown visibility */
      select:focus {
        z-index: 10;
        position: relative;
      }
      
      /* Better scrolling on mobile */
      .modal-content {
        -webkit-overflow-scrolling: touch;
      }
      
      /* Larger text for better readability */
      .modal h3 {
        font-size: 1.125rem;
      }
      
      /* Better button spacing */
      .modal button {
        min-width: 44px;
        min-height: 44px;
      }
    }
    
    /* Prevent zoom on input focus on iOS */
    @media screen and (-webkit-min-device-pixel-ratio: 0) {
      select, input, textarea {
        font-size: 16px;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">

  <!-- Header -->
  <header class="glass-effect shadow-sm sticky top-0 z-40 border-b border-gray-200">
    <div class="px-5 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl gradient-bg flex items-center justify-center text-white text-xl">
            🏥
          </div>
          <div>
            <h1 class="text-xl font-bold text-gray-800">Insurance CRM</h1>
            <p class="text-xs text-gray-500 font-light">Care Supreme - Policy Management</p>
          </div>
        </div>
        <button onclick="switchTab('settings')" id="tab-settings" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white hover:bg-gray-100 border border-gray-200 transition-all text-xl">
          ⚙️
        </button>
      </div>
    </div>
    
    <!-- Tabs -->
    <div class="flex gap-2 px-4 pb-4">
      <button onclick="switchTab('all')" id="tab-all" class="tab-active flex-1 px-4 py-2.5 text-xs font-semibold rounded-xl">
        All <span id="count-all" class="ml-1">0</span>
      </button>
      <button onclick="switchTab('pending')" id="tab-pending" class="flex-1 px-4 py-2.5 text-xs font-semibold text-gray-600 bg-white rounded-xl">
        Pending <span id="count-pending" class="ml-1">0</span>
      </button>
      <button onclick="switchTab('contacted')" id="tab-contacted" class="flex-1 px-4 py-2.5 text-xs font-semibold text-gray-600 bg-white rounded-xl">
        Done <span id="count-contacted" class="ml-1">0</span>
      </button>
      <button onclick="switchTab('callback')" id="tab-callback" class="flex-1 px-4 py-2.5 text-xs font-semibold text-gray-600 bg-white rounded-xl">
        Callback <span id="count-callback" class="ml-1">0</span>
      </button>
    </div>
    
    <!-- Done Filter Chips (shown only when Done tab is active) -->
    <div id="doneFilterChips" class="px-4 pb-4 hidden">
      <div class="flex gap-2 flex-wrap">
        <button onclick="setDoneFilter('all')" id="chip-all" class="chip-filter chip-active px-3 py-1.5 text-xs font-semibold rounded-full">
          All
        </button>
        <button onclick="setDoneFilter('interested')" id="chip-interested" class="chip-filter px-3 py-1.5 text-xs font-semibold rounded-full bg-green-50 text-green-600">
          ✅ Interested
        </button>
        <button onclick="setDoneFilter('not_interested')" id="chip-not_interested" class="chip-filter px-3 py-1.5 text-xs font-semibold rounded-full bg-red-50 text-red-600">
          ❌ Not Interested
        </button>
        <button onclick="setDoneFilter('wrong_number')" id="chip-wrong_number" class="chip-filter px-3 py-1.5 text-xs font-semibold rounded-full bg-gray-50 text-gray-600">
          🚫 Wrong Number
        </button>
        <button onclick="setDoneFilter('not_reachable')" id="chip-not_reachable" class="chip-filter px-3 py-1.5 text-xs font-semibold rounded-full bg-orange-50 text-orange-600">
          📵 Not Reachable
        </button>
        <button onclick="setDoneFilter('already_renewed')" id="chip-already_renewed" class="chip-filter px-3 py-1.5 text-xs font-semibold rounded-full bg-blue-50 text-blue-600">
          ✔️ Renewed
        </button>
        <button onclick="setDoneFilter('will_think')" id="chip-will_think" class="chip-filter px-3 py-1.5 text-xs font-semibold rounded-full bg-purple-50 text-purple-600">
          🤔 Thinking
        </button>
      </div>
    </div>
  </header>

  <!-- Search Bar -->
  <div id="searchBar" class="px-5 py-4">
    <div class="relative">
      <input type="text" id="searchInput" placeholder="Search by name, policy, or phone..." 
        class="w-full pl-11 pr-4 py-3 bg-white border border-gray-200 rounded-2xl text-sm">
      <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">🔍</span>
    </div>
  </div>

  <!-- Settings Tab Content -->
  <div id="settingsContent" class="px-5 py-6 hidden">
    <div class="max-w-2xl mx-auto space-y-5">
      <!-- Import Section -->
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-3xl p-6 border-2 border-blue-100 shadow-sm">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-2xl flex-shrink-0">
            📥
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Import Customer Data</h3>
            <p class="text-sm text-gray-600 mb-4 leading-relaxed">Upload your CSV file with customer leads. Make sure to use the correct format by downloading our template first.</p>
            
            <div class="flex gap-3">
              <button onclick="downloadSampleTemplate()" class="flex-1 bg-white border-2 border-blue-300 text-blue-700 font-semibold py-3 px-5 rounded-xl text-sm hover:bg-blue-50 hover:border-blue-400 transition-all shadow-sm">
                📄 Download Template
              </button>
              
              <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
              <button onclick="document.getElementById('csvFileInput').click()" class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold py-3 px-5 rounded-xl text-sm hover:shadow-lg transition-all">
                📤 Upload CSV
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Export Section -->
      <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-3xl p-6 border-2 border-green-100 shadow-sm">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-2xl flex-shrink-0">
            📤
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Export Complete Data</h3>
            <p class="text-sm text-gray-600 mb-4 leading-relaxed">Download all customer leads with complete disposition history, notes, callbacks, and interaction timeline.</p>
            
            <button onclick="exportData()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold py-3 px-5 rounded-xl text-sm hover:shadow-lg transition-all">
              💾 Export to CSV
            </button>
          </div>
        </div>
      </div>

      <!-- Restore Backup Section -->
      <div class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-3xl p-6 border-2 border-orange-100 shadow-sm">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-orange-500 to-amber-600 flex items-center justify-center text-2xl flex-shrink-0">
            ⚡
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Restore from Backup</h3>
            <p class="text-sm text-gray-600 mb-4 leading-relaxed">Upload previously exported CSV file to restore all data including complete disposition history and notes.</p>
            
            <input type="file" id="backupFileInput" accept=".csv" class="hidden" onchange="handleBackupRestore(event)">
            <button onclick="document.getElementById('backupFileInput').click()" class="w-full bg-gradient-to-r from-orange-500 to-amber-600 text-white font-semibold py-3 px-5 rounded-xl text-sm hover:shadow-lg transition-all">
              📥 Restore Backup
            </button>
          </div>
        </div>
      </div>

      <!-- Stats Section -->
      <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-3xl p-6 border-2 border-purple-100 shadow-sm">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center text-2xl flex-shrink-0">
            📊
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-bold text-gray-800 mb-3">System Statistics</h3>
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-white rounded-xl p-4">
                <div class="text-2xl font-bold text-purple-600" id="stat-total">0</div>
                <div class="text-xs text-gray-500 mt-1">Total Leads</div>
              </div>
              <div class="bg-white rounded-xl p-4">
                <div class="text-2xl font-bold text-green-600" id="stat-contacted">0</div>
                <div class="text-xs text-gray-500 mt-1">Contacted</div>
              </div>
              <div class="bg-white rounded-xl p-4">
                <div class="text-2xl font-bold text-orange-600" id="stat-pending">0</div>
                <div class="text-xs text-gray-500 mt-1">Pending</div>
              </div>
              <div class="bg-white rounded-xl p-4">
                <div class="text-2xl font-bold text-yellow-600" id="stat-callback">0</div>
                <div class="text-xs text-gray-500 mt-1">Callbacks</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cards Container -->
  <div id="cardsContainer" class="px-5 pb-6 space-y-4"></div>

  <!-- Disposition Modal -->
  <div id="dispositionModal" class="modal">
    <div class="modal-content bg-white rounded-3xl shadow-2xl mx-4 w-full max-w-md max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white rounded-t-3xl px-6 py-5 flex justify-between items-center border-b border-gray-100">
        <h3 class="text-lg font-bold text-gray-800">Update Status</h3>
        <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-400 hover:text-gray-600 text-2xl transition-all">×</button>
      </div>
      
      <div class="p-6 space-y-5">
        <div id="modalCustomerInfo" class="bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-2xl text-sm"></div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Disposition</label>
          <select id="dispositionSelect" class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl text-sm transition-all">
            <option value="">Select status...</option>
            <option value="interested">✅ Interested</option>
            <option value="not_interested">❌ Not Interested</option>
            <option value="callback">📞 Callback Required</option>
            <option value="wrong_number">🚫 Wrong Number</option>
            <option value="not_reachable">📵 Not Reachable</option>
            <option value="already_renewed">✔️ Already Renewed</option>
            <option value="will_think">🤔 Will Think</option>
          </select>
        </div>

        <div id="callbackSection" style="display:none;">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Callback Date & Time</label>
          <input type="datetime-local" id="callbackDateTime" class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl text-sm transition-all">
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Notes</label>
          <textarea id="dispositionNotes" rows="3" placeholder="Add notes about the conversation..." 
            class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl text-sm transition-all resize-none"></textarea>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">History</label>
          <div id="dispositionHistory" class="max-h-40 overflow-y-auto bg-gray-50 border border-gray-100 rounded-xl p-3 text-xs text-gray-700"></div>
        </div>

        <button onclick="saveDisposition()" class="w-full btn-primary text-white font-semibold py-3.5 rounded-xl">
          Save & Close
        </button>
      </div>
    </div>
  </div>

  <script>
    const data = [
        ];

    let dispositions = {};
    const STORAGE_KEY = 'rnl_dispositions';
    const DATA_STORAGE_KEY = 'rnl_customer_data';
    let currentTab = 'all';
    let currentDoneFilter = 'all';
    let currentLeadId = null;

    // Function to generate unique lead ID
    function generateLeadId() {
      return 'LEAD_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6).toUpperCase();
    }

    // Function to get lead ID from existing data or generate new one
    function getOrCreateLeadId(item) {
      if (item.leadId) {
        return item.leadId;
      }
      // Generate lead ID based on phone + name combination for existing data
      const baseId = 'LEAD_' + (item.phone + '_' + item.name).replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
      const existingIds = data.map(d => d.leadId).filter(Boolean);
      let leadId = baseId;
      let counter = 1;
      while (existingIds.includes(leadId)) {
        leadId = baseId + '_' + counter;
        counter++;
      }
      return leadId;
    }

    function getWhatsAppLink(item) {
      const basePremium = item.amount - item.addonCost;
      const discountAmount = Math.round(basePremium * 0.05);
      const finalAmount = basePremium - discountAmount;
      
      const message = ``;

      return `https://wa.me/91${item.phone}?text=${encodeURIComponent(message)}`;
    }

    function getDisposition(leadId) {
      const d = dispositions[leadId];
      if (!d) return { status: 'pending', notes: '', callback: null, history: [] };
      if (!Array.isArray(d.history)) d.history = [];
      return d;
    }

    function setDisposition(leadId, data) {
      dispositions[leadId] = data;
      saveDispositions();
      renderCards();
      updateCounts();
    }

    function loadDispositions() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          dispositions = JSON.parse(raw) || {};
        }
      } catch (e) {
        console.warn('Could not load dispositions from localStorage', e);
        dispositions = {};
      }
      
      try {
        const customData = localStorage.getItem(DATA_STORAGE_KEY);
        if (customData) {
          const parsed = JSON.parse(customData);
          if (Array.isArray(parsed) && parsed.length > 0) {
            data.length = 0;
            data.push(...parsed);
            
            // Migrate existing data to use lead IDs
            let needsMigration = false;
            data.forEach(item => {
              if (!item.leadId) {
                item.leadId = getOrCreateLeadId(item);
                needsMigration = true;
              }
            });
            
            // Migrate dispositions from policy-based to leadId-based
            const newDispositions = {};
            Object.keys(dispositions).forEach(key => {
              const item = data.find(d => d.policy === key || d.leadId === key);
              if (item && item.leadId) {
                newDispositions[item.leadId] = dispositions[key];
              }
            });
            dispositions = newDispositions;
            
            if (needsMigration) {
              saveDispositions();
              localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify(data));
            }
          }
        }
      } catch (e) {
        console.warn('Could not load custom data', e);
      }
    }

    function saveDispositions() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(dispositions));
      } catch (e) {
        console.warn('Could not save dispositions to localStorage', e);
      }
    }

    function getStatusBadge(status) {
      const badges = {
        pending: '<span class="badge bg-gray-100 text-gray-600">⏳ Pending</span>',
        interested: '<span class="badge bg-green-50 text-green-600">✅ Interested</span>',
        not_interested: '<span class="badge bg-red-50 text-red-600">❌ Not Interested</span>',
        callback: '<span class="badge bg-yellow-50 text-yellow-600">📞 Callback</span>',
        wrong_number: '<span class="badge bg-gray-50 text-gray-500">🚫 Wrong Number</span>',
        not_reachable: '<span class="badge bg-orange-50 text-orange-600">📵 Not Reachable</span>',
        already_renewed: '<span class="badge bg-blue-50 text-blue-600">✔️ Renewed</span>',
        will_think: '<span class="badge bg-purple-50 text-purple-600">🤔 Thinking</span>'
      };
      return badges[status] || badges.pending;
    }

    function renderCards() {
      const container = document.getElementById("cardsContainer");
      const searchTerm = document.getElementById("searchInput").value.toLowerCase();
      
      container.innerHTML = '';
      
      let filtered = data.filter(item => {
        // Ensure leadId exists
        if (!item.leadId) {
          item.leadId = getOrCreateLeadId(item);
        }
        
        const disp = getDisposition(item.leadId);
        const matchesSearch = !searchTerm || 
          item.name.toLowerCase().includes(searchTerm) ||
          item.policy.includes(searchTerm) ||
          item.phone.includes(searchTerm);
        
        if (!matchesSearch) return false;
        
        if (currentTab === 'all') return true;
        if (currentTab === 'pending') return disp.status === 'pending';
        if (currentTab === 'contacted') {
          const isDone = disp.status !== 'pending' && disp.status !== 'callback';
          if (!isDone) return false;
          
          if (currentDoneFilter === 'all') return true;
          return disp.status === currentDoneFilter;
        }
        if (currentTab === 'callback') return disp.status === 'callback';
        
        return true;
      });

      if (filtered.length === 0) {
        container.innerHTML = '<div class="text-center py-16 text-gray-400 text-sm">No records found</div>';
        return;
      }

      if (currentTab === 'contacted') {
        filtered.sort((a, b) => {
          const dispA = getDisposition(a.leadId);
          const dispB = getDisposition(b.leadId);
          const timeA = dispA.lastUpdated ? new Date(dispA.lastUpdated).getTime() : 0;
          const timeB = dispB.lastUpdated ? new Date(dispB.lastUpdated).getTime() : 0;
          return timeB - timeA;
        });
      }

      filtered.forEach(item => {
        const disp = getDisposition(item.leadId);
        const hasCallback = disp.callback && new Date(disp.callback) > new Date();
        
        const card = document.createElement("div");
        card.className = "card bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden";

        card.innerHTML = `
          <div class="p-5">
            <div class="flex justify-between items-start mb-4">
              <div class="flex-1">
                <h3 class="font-bold text-gray-800 text-base mb-1 leading-tight">${item.name}</h3>
                <p class="text-xs text-gray-400 font-light">Expiry: ${item.date}</p>
              </div>
              ${getStatusBadge(disp.status)}
            </div>
            
            ${hasCallback ? `
              <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-100 rounded-xl p-3 mb-4 text-xs">
                <div class="flex items-center gap-2">
                  <span class="text-lg">⏰</span>
                  <div>
                    <div class="font-semibold text-yellow-800">Callback Scheduled</div>
                    <div class="text-yellow-700 mt-0.5">${new Date(disp.callback).toLocaleString('en-IN', {day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'})}</div>
                  </div>
                </div>
              </div>
            ` : ''}
            
            <div class="space-y-2 mb-4">
            
              ${item.sumInsured ? `<div class='flex items-center justify-between text-sm'><span class='text-gray-400 font-light'>Sum Insured</span><span class='text-gray-700'>${item.sumInsured}</span></div>` : ''}
              ${item.premium ? `<div class='flex items-center justify-between text-sm'><span class='text-gray-400 font-light'>Premium</span><span class='text-gray-800 font-bold'>₹${item.premium.toLocaleString("en-IN")}</span></div>` : ''}
              ${item.company ? `<div class='flex items-center justify-between text-sm'><span class='text-gray-400 font-light'>Company</span><span class='text-gray-700'>${item.company}</span></div>` : ''}
              ${item.mainCustomFields ? Object.entries(item.mainCustomFields).map(([label, value]) => `<div class='flex items-center justify-between text-sm'><span class='text-gray-400 font-light'>${label}</span><span class='text-gray-700'>${value}</span></div>`).join('') : ''}
            </div>
            
              <div class="bg-gray-50 rounded-xl p-3 mb-4 text-xs text-gray-600">
              <div class="font-medium text-gray-700 mb-1">Customer Details</div>
              <div class="leading-relaxed">${item.plan}</div>
              ${item.customerDetails ? `<div class="mt-2 text-gray-600">${item.customerDetails}</div>` : ''}
              ${item.addonCost > 0 ? `<div class="mt-2 text-purple-600 font-medium">Add-on Cost: ₹${item.addonCost.toLocaleString("en-IN")}</div>` : ''}
            </div>            ${disp.notes ? `
              <div class="bg-blue-50 rounded-xl p-3 mb-4 text-xs">
                <div class="flex gap-2">
                  <span class="text-base">📝</span>
                  <div class="text-gray-700 leading-relaxed">${disp.notes}</div>
                </div>
              </div>
            ` : ''}
            
            <div class="grid grid-cols-3 gap-2">
              <a href="tel:${item.phone}" 
                class="btn-call text-white font-semibold py-3 px-2 rounded-xl text-xs text-center flex items-center justify-center">
                📞 Call
              </a>
              <a href="${getWhatsAppLink(item)}" 
                target="_blank"
                class="btn-whatsapp text-white font-semibold py-3 px-2 rounded-xl text-xs text-center flex items-center justify-center">
                💬 WhatsApp
              </a>
              <button onclick="openModal('${item.leadId}')" 
                class="btn-primary text-white font-semibold py-3 px-2 rounded-xl text-xs">
                Update
              </button>
            </div>
            
            <div class="mt-3 text-center">
              <span class="text-xs text-gray-400 font-light">${item.phone}</span>
            </div>
          </div>
        `;
        
        container.appendChild(card);
      });
    }

    function switchTab(tab) {
      currentTab = tab;
      
      document.querySelectorAll('[id^="tab-"]').forEach(t => {
        t.classList.remove('tab-active');
        t.classList.add('text-gray-600', 'bg-white');
      });
      
      document.getElementById(`tab-${tab}`).classList.add('tab-active');
      document.getElementById(`tab-${tab}`).classList.remove('text-gray-600', 'bg-white');
      
      const searchBar = document.getElementById('searchBar');
      const cardsContainer = document.getElementById('cardsContainer');
      const settingsContent = document.getElementById('settingsContent');
      const doneChips = document.getElementById('doneFilterChips');
      
      if (tab === 'settings') {
        searchBar.classList.add('hidden');
        cardsContainer.classList.add('hidden');
        doneChips.classList.add('hidden');
        settingsContent.classList.remove('hidden');
        updateSettingsStats();
      } else {
        searchBar.classList.remove('hidden');
        cardsContainer.classList.remove('hidden');
        settingsContent.classList.add('hidden');
        
        if (tab === 'contacted') {
          doneChips.classList.remove('hidden');
        } else {
          doneChips.classList.add('hidden');
          currentDoneFilter = 'all';
        }
        
        renderCards();
      }
    }

    function updateSettingsStats() {
      const all = data.length;
      const pending = data.filter(item => {
        if (!item.leadId) item.leadId = getOrCreateLeadId(item);
        return getDisposition(item.leadId).status === 'pending';
      }).length;
      const contacted = data.filter(item => {
        if (!item.leadId) item.leadId = getOrCreateLeadId(item);
        const status = getDisposition(item.leadId).status;
        return status !== 'pending' && status !== 'callback';
      }).length;
      const callback = data.filter(item => {
        if (!item.leadId) item.leadId = getOrCreateLeadId(item);
        return getDisposition(item.leadId).status === 'callback';
      }).length;
      
      document.getElementById('stat-total').textContent = all;
      document.getElementById('stat-contacted').textContent = contacted;
      document.getElementById('stat-pending').textContent = pending;
      document.getElementById('stat-callback').textContent = callback;
    }

    function setDoneFilter(filter) {
      currentDoneFilter = filter;
      
      document.querySelectorAll('.chip-filter').forEach(chip => {
        chip.classList.remove('chip-active');
      });
      
      document.getElementById(`chip-${filter}`).classList.add('chip-active');
      
      renderCards();
    }

    function updateCounts() {
      const all = data.length;
      const pending = data.filter(item => {
        if (!item.leadId) item.leadId = getOrCreateLeadId(item);
        return getDisposition(item.leadId).status === 'pending';
      }).length;
      const contacted = data.filter(item => {
        if (!item.leadId) item.leadId = getOrCreateLeadId(item);
        const status = getDisposition(item.leadId).status;
        return status !== 'pending' && status !== 'callback';
      }).length;
      const callback = data.filter(item => {
        if (!item.leadId) item.leadId = getOrCreateLeadId(item);
        return getDisposition(item.leadId).status === 'callback';
      }).length;
      
      document.getElementById('count-all').textContent = all;
      document.getElementById('count-pending').textContent = pending;
      document.getElementById('count-contacted').textContent = contacted;
      document.getElementById('count-callback').textContent = callback;
    }

    function openModal(leadId) {
      currentLeadId = leadId;
      const item = data.find(d => d.leadId === leadId);
      const disp = getDisposition(leadId);
      
      document.getElementById('modalCustomerInfo').innerHTML = `
        <div class="font-bold text-gray-800 text-base">${item.name}</div>
        <div class="text-xs text-gray-600 mt-2 font-light">Policy: ${item.policy}</div>
        <div class="text-xs text-gray-500 mt-1 font-light">Lead ID: ${item.leadId}</div>
      `;
      
      document.getElementById('dispositionSelect').value = disp.status === 'pending' ? '' : disp.status;
      document.getElementById('dispositionNotes').value = disp.notes || '';
      document.getElementById('callbackDateTime').value = disp.callback || '';

      renderHistory(disp.history || []);
      
      document.getElementById('dispositionModal').classList.add('active');
      
      if (disp.status === 'callback') {
        document.getElementById('callbackSection').style.display = 'block';
      }
    }

    function closeModal() {
      document.getElementById('dispositionModal').classList.remove('active');
      currentLeadId = null;
    }

    function saveDisposition() {
      if (!currentLeadId) return;
      
      const status = document.getElementById('dispositionSelect').value;
      const notes = document.getElementById('dispositionNotes').value;
      const callback = document.getElementById('callbackDateTime').value;
      
      if (!status) {
        alert('Please select a disposition');
        return;
      }
      
      const disp = getDisposition(currentLeadId);
      disp.status = status;
      disp.notes = notes;
      disp.callback = status === 'callback' ? callback : null;
      disp.lastUpdated = new Date().toISOString();

      if (!disp.history) disp.history = [];
      const entry = {
        status,
        notes,
        callback: disp.callback || null,
        timestamp: new Date().toISOString()
      };
      disp.history.push(entry);

      setDisposition(currentLeadId, disp);
      renderHistory(disp.history);
      closeModal();
    }

    function renderHistory(history) {
      const el = document.getElementById('dispositionHistory');
      if (!el) return;
      if (!history || history.length === 0) {
        el.innerHTML = '<div class="text-gray-400">No history yet</div>';
        return;
      }

      const list = history.slice().reverse().map(h => {
        const dt = new Date(h.timestamp);
        const dateStr = dt.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        const timeStr = dt.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
        const statusLabel = h.status ? h.status.replace(/_/g, ' ') : 'pending';
        const notes = h.notes ? `<div class="text-gray-700 mt-1">${escapeHtml(h.notes)}</div>` : '';
        const cb = h.callback ? `<div class="text-xs text-yellow-700 mt-1">Callback: ${new Date(h.callback).toLocaleString('en-IN', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}</div>` : '';
        return `
          <div class="border-b border-gray-100 py-2">
            <div class="flex items-center justify-between">
              <div class="font-medium text-gray-700 text-sm">${escapeHtml(statusLabel)}</div>
              <div class="text-xs text-gray-400">${dateStr} ${timeStr}</div>
            </div>
            ${notes}
            ${cb}
          </div>
        `;
      }).join('');

      el.innerHTML = list;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    document.getElementById('dispositionSelect').addEventListener('change', (e) => {
      const section = document.getElementById('callbackSection');
      section.style.display = e.target.value === 'callback' ? 'block' : 'none';
    });

    document.getElementById('searchInput').addEventListener('input', renderCards);

    function downloadSampleTemplate() {
      const headers = ['policy_no', 'proposer', 'phone', 'plan_name', 'renewal_date', 'total_sum_insured', 'total_premium', 'proposed_addon_cost', 'ages'];
      const sampleData = [
        ['90931696', 'Boya Tribhuvan Teja', '9885562055', 'Care Supreme', '11-Oct-2025', '₹17,50,000', '7562', '645', '32'],
        ['91075578', 'Gurparshad Singh', '9501242244', 'Care Supreme', '12-Oct-2025', '₹15,00,000', '46627', '2151', '47, 44, 18, 14'],
        ['90931524', 'Boya Varalakshmi Dev', '9885562055', 'Care Supreme', '13-Oct-2025', '₹17,50,000', '105604', '2796', '65']
      ];
      
      const rows = [headers, ...sampleData];
      const csvContent = rows.map(row => row.join(',')).join('\n');
      
      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'Insurance_CRM_Import_Template.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      
      alert('✅ Template downloaded!\n\nUse these exact column headers:\n• policy_no\n• proposer\n• phone\n• plan_name\n• renewal_date\n• total_sum_insured\n• total_premium\n• proposed_addon_cost\n• ages');
    }

    // Field mapping modal HTML
    const mappingModalHtml = `
      <div id="mappingModal" class="modal">
        <div class="modal-content bg-white rounded-3xl shadow-2xl mx-2 sm:mx-4 w-full max-w-2xl max-h-[95vh] overflow-y-auto">
          <div class="sticky top-0 bg-white rounded-t-3xl px-4 sm:px-6 py-4 sm:py-5 flex justify-between items-center border-b border-gray-100 z-10">
            <h3 class="text-base sm:text-lg font-bold text-gray-800">Map CSV Fields</h3>
            <button onclick="document.getElementById('mappingModal').classList.remove('active')" class="w-10 h-10 sm:w-8 sm:h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-400 hover:text-gray-600 text-xl sm:text-2xl transition-all">×</button>
          </div>
          
          <div class="p-4 sm:p-6 space-y-4 sm:space-y-5">
            <div class="bg-blue-50 p-3 sm:p-4 rounded-xl text-xs sm:text-sm text-blue-700">
              Please map your CSV columns to the required fields below. Select the appropriate column for each field.
            </div>
            
            <div class="grid gap-3 sm:gap-4" id="mappingFields">
              <div class="bg-gray-50 p-3 sm:p-4 rounded-xl">
                <h4 class="font-semibold text-gray-800 mb-3 text-sm sm:text-base">Required Fields</h4>
                <div class="space-y-3 sm:space-y-4">
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div class="space-y-2">
                      <label class="block text-xs sm:text-sm font-medium text-gray-600">Name</label>
                      <div class="flex gap-2 items-center">
                        <select id="map_name" class="flex-1 px-3 py-2.5 sm:py-2 bg-white border border-gray-200 rounded-lg text-xs sm:text-sm max-h-40 overflow-y-auto min-h-[44px]"></select>
                        <button onclick="addMappingField('name')" class="px-3 py-2.5 sm:py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all text-xs sm:text-sm min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0">+</button>
                      </div>
                      <div class="flex items-center gap-2">
                        <input type="checkbox" id="show_name_main" class="ml-1" checked disabled title="Name always shown" />
                        <label for="show_name_main" class="text-xs text-gray-500">Show</label>
                      </div>
                      <div id="name_fields"></div>
                    </div>
                    <div class="space-y-2">
                      <label class="block text-xs sm:text-sm font-medium text-gray-600">Phone</label>
                      <div class="flex gap-2 items-center">
                        <select id="map_phone" class="flex-1 px-3 py-2.5 sm:py-2 bg-white border border-gray-200 rounded-lg text-xs sm:text-sm max-h-40 overflow-y-auto min-h-[44px]"></select>
                        <button onclick="addMappingField('phone')" class="px-3 py-2.5 sm:py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all text-xs sm:text-sm min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0">+</button>
                      </div>
                      <div class="flex items-center gap-2">
                        <input type="checkbox" id="show_phone_main" class="ml-1" checked disabled title="Phone always shown" />
                        <label for="show_phone_main" class="text-xs text-gray-500">Show</label>
                      </div>
                      <div id="phone_fields"></div>
                    </div>
                  </div>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div class="space-y-2">
                      <label class="block text-xs sm:text-sm font-medium text-gray-600">Sum Insured</label>
                      <div class="flex gap-2 items-center">
                        <select id="map_sum_insured" class="flex-1 px-3 py-2.5 sm:py-2 bg-white border border-gray-200 rounded-lg text-xs sm:text-sm max-h-40 overflow-y-auto min-h-[44px]"></select>
                        <button onclick="addMappingField('sum_insured')" class="px-3 py-2.5 sm:py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all text-xs sm:text-sm min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0">+</button>
                      </div>
                      <div class="flex items-center gap-2">
                        <input type="checkbox" id="show_sum_insured_main" class="ml-1" checked />
                        <label for="show_sum_insured_main" class="text-xs text-gray-500">Show</label>
                      </div>
                      <div id="sum_insured_fields"></div>
                    </div>
                    <div class="space-y-2">
                      <label class="block text-xs sm:text-sm font-medium text-gray-600">Premium</label>
                      <div class="flex gap-2 items-center">
                        <select id="map_premium" class="flex-1 px-3 py-2.5 sm:py-2 bg-white border border-gray-200 rounded-lg text-xs sm:text-sm max-h-40 overflow-y-auto min-h-[44px]"></select>
                        <button onclick="addMappingField('premium')" class="px-3 py-2.5 sm:py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all text-xs sm:text-sm min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0">+</button>
                      </div>
                      <div class="flex items-center gap-2">
                        <input type="checkbox" id="show_premium_main" class="ml-1" checked />
                        <label for="show_premium_main" class="text-xs text-gray-500">Show</label>
                      </div>
                      <div id="premium_fields"></div>
                    </div>
                  </div>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div class="space-y-2">
                      <label class="block text-xs sm:text-sm font-medium text-gray-600">Expiry Date</label>
                      <div class="flex gap-2 items-center">
                        <select id="map_expiry_date" class="flex-1 px-3 py-2.5 sm:py-2 bg-white border border-gray-200 rounded-lg text-xs sm:text-sm max-h-40 overflow-y-auto min-h-[44px]"></select>
                        <button onclick="addMappingField('expiry_date')" class="px-3 py-2.5 sm:py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all text-xs sm:text-sm min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0">+</button>
                      </div>
                      <div class="flex items-center gap-2">
                        <input type="checkbox" id="show_expiry_date_main" class="ml-1" checked disabled title="Expiry always shown" />
                        <label for="show_expiry_date_main" class="text-xs text-gray-500">Show</label>
                      </div>
                      <div id="expiry_date_fields"></div>
                    </div>
                    <div class="space-y-2">
                      <label class="block text-xs sm:text-sm font-medium text-gray-600">Company</label>
                      <div class="flex gap-2 items-center">
                        <select id="map_company" class="flex-1 px-3 py-2.5 sm:py-2 bg-white border border-gray-200 rounded-lg text-xs sm:text-sm max-h-40 overflow-y-auto min-h-[44px]"></select>
                        <button onclick="addMappingField('company')" class="px-3 py-2.5 sm:py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all text-xs sm:text-sm min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0">+</button>
                      </div>
                      <div class="flex items-center gap-2">
                        <input type="checkbox" id="show_company_main" class="ml-1" checked />
                        <label for="show_company_main" class="text-xs text-gray-500">Show</label>
                      </div>
                      <div id="company_fields"></div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="bg-gray-50 p-3 sm:p-4 rounded-xl">
                <h4 class="font-semibold text-gray-800 mb-3 text-sm sm:text-base">Customer Details (Optional)</h4>
                <div class="space-y-3" id="additionalFieldsMapping"></div>
                <button onclick="addCustomField()" class="mt-3 text-xs sm:text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1 py-2 px-3 rounded-lg hover:bg-blue-50 transition-all min-h-[44px]">
                  <span class="text-base sm:text-lg">+</span> Add Custom Field
                </button>
              </div>
            </div>

            <button onclick="processMappedFields()" class="w-full btn-primary text-white font-semibold py-3.5 sm:py-4 rounded-xl text-sm sm:text-base min-h-[48px]">
              Import Data
            </button>
          </div>
        </div>
      </div>
    `;

    // Add mapping modal to body if not exists
    if (!document.getElementById('mappingModal')) {
      document.body.insertAdjacentHTML('beforeend', mappingModalHtml);
    }

    // CSV import related variables and functions
    (() => {
      let csvData = null;
      let csvHeaders = null;
      let additionalFields = [];
      let selectedOptions = new Set();
      let fieldMappings = {
        name: [],
        phone: [],
        sum_insured: [],
        premium: [],
        expiry_date: [],
        company: []
      };

      // Function to update available options in all selects
      function updateAvailableOptions() {
        window.updateAvailableOptions = updateAvailableOptions;
        // Clear selected options set
        selectedOptions.clear();
        
        // Collect all selected values
        const selects = ['map_name', 'map_phone', 'map_sum_insured', 'map_premium', 'map_expiry_date', 'map_company'];
        selects.forEach(selectId => {
          const select = document.getElementById(selectId);
          if (select && select.value) {
            selectedOptions.add(select.value);
          }
        });

        // Check additional fields
        Object.values(fieldMappings).flat().forEach(mappingId => {
          const select = document.getElementById(mappingId);
          if (select && select.value) {
            selectedOptions.add(select.value);
          }
        });

        // Check custom fields
        additionalFields.forEach(fieldId => {
          const select = document.getElementById(`${fieldId}_column`);
          if (select && select.value) {
            selectedOptions.add(select.value);
          }
        });

        // Update options in all selects
        function updateSelectOptions(select) {
          const currentValue = select.value;
          const options = ['<option value="">Select Column</option>'];
          
          if (csvHeaders) {
            csvHeaders.forEach(header => {
              // Show the option if it's either not selected anywhere, or it's the current value of this select
              if (!selectedOptions.has(header) || header === currentValue) {
                options.push(`<option value="${header}">${header}</option>`);
              }
            });
          }
          
          select.innerHTML = options.join('');
          select.value = currentValue; // Restore the current value
        }

        // Update main selects
        selects.forEach(selectId => {
          const select = document.getElementById(selectId);
          if (select) {
            updateSelectOptions(select);
          }
        });

        // Update additional field selects
        Object.values(fieldMappings).flat().forEach(mappingId => {
          const select = document.getElementById(mappingId);
          if (select) {
            updateSelectOptions(select);
          }
        });

        // Update custom field selects
        additionalFields.forEach(fieldId => {
          const select = document.getElementById(`${fieldId}_column`);
          if (select) {
            updateSelectOptions(select);
          }
        });
      }

      window.addMappingField = function(fieldType) {
        const container = document.getElementById(`${fieldType}_fields`) || document.getElementById(`map_${fieldType}`).parentElement;
        const mappingId = `${fieldType}_${Date.now()}`;
        
        const select = document.createElement('div');
        select.className = 'flex gap-2 mb-2';
        select.innerHTML = `
          <select id="${mappingId}" class="flex-1 px-3 py-2.5 sm:py-2 bg-white border border-gray-200 rounded-lg text-xs sm:text-sm min-h-[44px]" onchange="updateAvailableOptions()">
            <option value="">Select Column</option>
            ${csvHeaders ? csvHeaders.filter(h => !selectedOptions.has(h)).map(h => `<option value="${h}">${h}</option>`).join('') : ''}
          </select>
          <button onclick="removeMappingField('${mappingId}')" class="px-3 py-2.5 sm:py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all text-xs sm:text-sm min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0">
            ×
          </button>
        `;
        
        if (container.tagName === 'DIV') {
          container.appendChild(select);
        } else {
          const parentDiv = document.createElement('div');
          parentDiv.id = `${fieldType}_fields`;
          parentDiv.className = 'space-y-2';
          
          // Move the original select into the new container
          const originalContent = container.innerHTML;
          container.innerHTML = '';
          parentDiv.innerHTML = `<div class="flex gap-2 mb-2">${originalContent}</div>`;
          parentDiv.appendChild(select);
          
          container.parentElement.appendChild(parentDiv);
        }
        
        // Add to field mappings
        if (!fieldMappings[fieldType]) {
          fieldMappings[fieldType] = [];
        }
        fieldMappings[fieldType].push(mappingId);
      };

      window.removeMappingField = function(mappingId) {
        const element = document.getElementById(mappingId);
        const selectedValue = element?.value;
        
        if (element && element.parentElement) {
          element.parentElement.remove();
        }
        
        // Remove from field mappings
        for (const [fieldType, mappings] of Object.entries(fieldMappings)) {
          const index = mappings.indexOf(mappingId);
          if (index !== -1) {
            mappings.splice(index, 1);
            break;
          }
        }

        // Update available options after removing a field
        updateAvailableOptions();
      };

      window.addCustomField = function() {
        const container = document.getElementById('additionalFieldsMapping');
        const fieldId = 'custom_' + Date.now();
        
        // Filter out already selected options
        const availableHeaders = csvHeaders ? csvHeaders.filter(h => !selectedOptions.has(h)) : [];
        
        const fieldHtml = `
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 items-start sm:items-center space-y-2 sm:space-y-0" id="${fieldId}_container">
            <div class="space-y-1">
              <input type="text" placeholder="Field Label" class="w-full px-3 py-2.5 sm:py-2 bg-white border border-gray-200 rounded-lg text-xs sm:text-sm min-h-[44px]" 
                id="${fieldId}_label">
            </div>
            <div class="space-y-2">
              <div class="flex gap-2 items-center">
                <select class="flex-1 px-3 py-2.5 sm:py-2 bg-white border border-gray-200 rounded-lg text-xs sm:text-sm min-h-[44px]" 
                        id="${fieldId}_column" 
                        onchange="updateAvailableOptions()">
                  <option value="">Select Column</option>
                  ${availableHeaders.map(h => `<option value="${h}">${h}</option>`).join('')}
                </select>
                <button onclick="removeCustomField('${fieldId}')" 
                  class="px-3 py-2.5 sm:py-2 text-red-500 hover:bg-red-50 rounded-lg text-xs sm:text-sm min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0">×</button>
              </div>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="show_custom_main_${fieldId}" class="ml-1" />
                <label for="show_custom_main_${fieldId}" class="text-xs text-gray-500">Show</label>
              </div>
            </div>
          </div>
        `;
        
        container.insertAdjacentHTML('beforeend', fieldHtml);
        additionalFields.push(fieldId);
        
        // Add this field's select to the tracking
        fieldMappings['custom'] = fieldMappings['custom'] || [];
        fieldMappings['custom'].push(`${fieldId}_column`);
      };

      window.removeCustomField = function(fieldId) {
        const container = document.getElementById(`${fieldId}_container`);
        const select = document.getElementById(`${fieldId}_column`);
        
        // Remove from fieldMappings
        if (fieldMappings['custom']) {
          const index = fieldMappings['custom'].indexOf(`${fieldId}_column`);
          if (index !== -1) {
            fieldMappings['custom'].splice(index, 1);
          }
        }
        
        // Remove from additionalFields
        const addIndex = additionalFields.indexOf(fieldId);
        if (addIndex !== -1) {
          additionalFields.splice(addIndex, 1);
        }
        
        // Remove the container
        if (container) {
          container.remove();
        }
        
        // Update available options
        updateAvailableOptions();
      };

      window.processMappedFields = function() {
        // Get values from all mapped fields
        const mapping = {};
        const multiMapping = {};
        
        for (const [fieldType, mappingIds] of Object.entries(fieldMappings)) {
          const mainEl = document.getElementById(`map_${fieldType}`);
          const mainValue = mainEl ? mainEl.value : '';
          if (!mainValue) {
            const additionalValues = mappingIds
              .map(id => {
                const el = document.getElementById(id);
                return el ? el.value : '';
              })
              .filter(Boolean);
            
            if (additionalValues.length === 0) {
              mapping[fieldType] = '';
            } else {
              mapping[fieldType] = additionalValues[0];
              if (additionalValues.length > 1) {
                multiMapping[fieldType] = additionalValues.slice(1);
              }
            }
          } else {
            mapping[fieldType] = mainValue;
            const additionalValues = mappingIds
              .map(id => {
                const el = document.getElementById(id);
                return el ? el.value : '';
              })
              .filter(Boolean);
            if (additionalValues.length > 0) {
              multiMapping[fieldType] = additionalValues;
            }
          }
        }

        // Validate required fields
        const missingFields = [];
        for (const [field, value] of Object.entries(mapping)) {
          if (!value) missingFields.push(field.replace('_', ' '));
        }

        if (missingFields.length > 0) {
          alert(`❌ Please map all required fields:\n\n${missingFields.join('\n')}`);
          return;
        }

        // Get additional field mappings
        const additionalMappings = {};
        additionalFields.forEach(fieldId => {
          const labelEl = document.getElementById(`${fieldId}_label`);
          const columnEl = document.getElementById(`${fieldId}_column`);
          if (labelEl && columnEl && labelEl.value && columnEl.value) {
            additionalMappings[labelEl.value] = columnEl.value;
          }
        });

        // Process the CSV data with mappings
        const newData = [];
        let errorCount = 0;

        for (let i = 1; i < csvData.length; i++) {
          const row = csvData[i];
          if (!row || row.length === 0) continue;

          try {
            const getCell = (columnName) => {
              const idx = csvHeaders.indexOf(columnName);
              return idx >= 0 ? (row[idx] ? row[idx].trim() : '') : '';
            };

            // Get mapped values (avoid duplicate columns, preserve order)
            const getCombinedValue = (mainMapping, additionalMappings = []) => {
              const allMappings = [mainMapping, ...additionalMappings].filter(Boolean);
              // Remove duplicates
              const uniqueMappings = [...new Set(allMappings)];
              const values = uniqueMappings.map(m => getCell(m)).filter(Boolean);
              return values.join(' ').replace(/\s+/g, ' ').trim();
            };

            const name = getCombinedValue(mapping.name, multiMapping.name || []);
            console.log('DEBUG name:', name, 'from', mapping.name, multiMapping.name);
            const phone = getCombinedValue(mapping.phone, multiMapping.phone || []).replace(/[^0-9]/g, '');
            const sumInsured = getCombinedValue(mapping.sum_insured, multiMapping.sum_insured || []);
            const premium = parseInt(getCombinedValue(mapping.premium, multiMapping.premium || []).replace(/[^0-9]/g, '')) || 0;
            const expiryDate = getCombinedValue(mapping.expiry_date, multiMapping.expiry_date || []);
            const company = getCombinedValue(mapping.company, multiMapping.company || []);

            // Skip if essential data is missing
            if (!name || !phone) {
              errorCount++;
              continue;
            }

            // Build mainFields and customerDetails based on checkboxes
            const mainFields = {
              sumInsured: document.getElementById('show_sum_insured_main')?.checked ? sumInsured : null,
              premium: document.getElementById('show_premium_main')?.checked ? premium : null,
              company: document.getElementById('show_company_main')?.checked ? company : null,
            };
            // Custom fields
            const mainCustomFields = {};
            const customerDetailsArr = [];
            for (const [label, column] of Object.entries(additionalMappings)) {
              const value = getCell(column);
              const fieldId = additionalFields.find(fid => {
                const lbl = document.getElementById(`${fid}_label`);
                return lbl && lbl.value === label;
              });
              if (fieldId && document.getElementById(`show_custom_main_${fieldId}`)?.checked) {
                mainCustomFields[label] = value;
              } else if (value) {
                customerDetailsArr.push(`${label}: ${value}`);
              }
            }
            const item = {
              sno: newData.length + 1,
              leadId: generateLeadId(),
              policy: getCell(mapping.policy_no) || `POL${Math.random().toString(36).substr(2, 8).toUpperCase()}`,
              name: name,
              phone: phone,
              date: expiryDate,
              sumInsured: mainFields.sumInsured,
              premium: mainFields.premium,
              company: mainFields.company,
              mainCustomFields,
              amount: premium,
              addonCost: 0,
              customerDetails: customerDetailsArr.join(' | ')
            };

            newData.push(item);
          } catch (err) {
            errorCount++;
            console.warn(`Error processing row ${i}:`, err);
          }
        }

        if (newData.length === 0) {
          alert('❌ No valid data found in CSV file');
          return;
        }

        // Check for duplicates and filter them out
        const existingLeadIds = new Set(data.map(item => item.leadId).filter(Boolean));
        const uniqueNewData = newData.filter(item => !existingLeadIds.has(item.leadId));
        const duplicateCount = newData.length - uniqueNewData.length;

        let confirmMsg = `Import ${uniqueNewData.length} new leads?\n\n`;
        confirmMsg += `📊 Current leads: ${data.length}\n`;
        confirmMsg += `➕ New leads to add: ${uniqueNewData.length}\n`;
        if (duplicateCount > 0) {
          confirmMsg += `⚠️ Duplicates skipped: ${duplicateCount}\n`;
        }
        if (errorCount > 0) {
          confirmMsg += `❌ Errors skipped: ${errorCount}\n`;
        }
        confirmMsg += `\n✅ Existing data will remain unchanged.`;

        if (!confirm(confirmMsg)) {
          return;
        }

        // Append new data to existing data
        data.push(...uniqueNewData);
        localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify(data));

        // Close mapping modal and refresh UI
        document.getElementById('mappingModal').classList.remove('active');
        renderCards();
        updateCounts();

        let successMsg = `✅ Successfully imported ${uniqueNewData.length} new leads!\n\n`;
        successMsg += `📊 Total leads now: ${data.length}\n`;
        if (duplicateCount > 0) {
          successMsg += `⚠️ ${duplicateCount} duplicates were skipped.\n`;
        }
        if (errorCount > 0) {
          successMsg += `❌ ${errorCount} rows had errors and were skipped.\n`;
        }
        successMsg += `\n✨ Existing data preserved successfully.`;
        
        alert(successMsg);
      };

      window.handleFileUpload = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const text = e.target.result;
              csvData = text.split('\n').map(row => {
                // Split on comma, trim each cell, remove quotes
                return row.split(',').map(cell => cell.replace(/^"|"$/g, '').trim());
              }).filter(row => row.length > 0);

              if (csvData.length < 2) {
                alert('❌ CSV file must have headers and at least one data row');
                return;
              }

              csvHeaders = csvData[0].map(h => h.trim());
              additionalFields = []; // Reset additional fields

              // Populate mapping dropdowns
              const selects = ['map_name', 'map_phone', 'map_sum_insured', 'map_premium', 'map_expiry_date', 'map_company'];
              selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select Column</option>' +
                  csvHeaders.map(h => `<option value="${h}">${h}</option>`).join('');
                // Add change event listener
                select.addEventListener('change', () => {
                  updateAvailableOptions();
                });
              });

              // Show mapping modal
              document.getElementById('mappingModal').classList.add('active');
            } catch (error) {
              alert('❌ Error processing CSV file: ' + error.message);
              console.error('CSV processing error:', error);
            }
          };

          reader.onerror = function() {
            alert('❌ Error reading file');
            console.error('FileReader error:', reader.error);
          };

          reader.readAsText(file);
        } catch (error) {
          alert('❌ Error handling file: ' + error.message);
          console.error('File handling error:', error);
        } finally {
          event.target.value = '';
        }
      };
    })();

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      try {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const text = e.target.result;
            csvData = text.split('\n').map(row => {
              const matches = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
              return matches ? matches.map(cell => cell.replace(/^"|"$/g, '').trim()) : [];
            }).filter(row => row.length > 0);

            if (csvData.length < 2) {
              alert('❌ CSV file must have headers and at least one data row');
              return;
            }

            csvHeaders = csvData[0].map(h => h.trim());
            additionalFields = []; // Reset additional fields

            // Populate mapping dropdowns
            const selects = ['map_name', 'map_phone', 'map_sum_insured', 'map_premium', 'map_expiry_date', 'map_company'];
            selects.forEach(selectId => {
              const select = document.getElementById(selectId);
              select.innerHTML = '<option value="">Select Column</option>' +
                csvHeaders.map(h => `<option value="${h}">${h}</option>`).join('');
            });

            // Show mapping modal
            document.getElementById('mappingModal').classList.add('active');
          } catch (error) {
            alert('❌ Error processing CSV file: ' + error.message);
            console.error('CSV processing error:', error);
          }
        };

        reader.onerror = function() {
          alert('❌ Error reading file');
          console.error('FileReader error:', reader.error);
        };

        reader.readAsText(file);
      } catch (error) {
        alert('❌ Error handling file: ' + error.message);
        console.error('File handling error:', error);
      } finally {
        event.target.value = '';
      }
          
    }

    // Load initial data and initialize UI
    loadDispositions();
    renderCards();
    updateCounts();
    
    // Initialize mapping modal
    if (!document.getElementById('mappingModal')) {
      document.body.insertAdjacentHTML('beforeend', mappingModalHtml);
    }
    

    function exportData() {
      if (data.length === 0) {
        alert('❌ No data to export!');
        return;
      }

      const headers = [
        'Lead ID',
        'Phone No',
        'Name',
        'Expiry Date',
        'Customer Details',
        'Utilities'
      ];
      
      const exportRows = data.map(item => {
        if (!item.leadId) item.leadId = getOrCreateLeadId(item);
        const disp = getDisposition(item.leadId);
        const callCount = (disp.history || []).length;
        
        const dispositionLog = (disp.history || []).map((h, idx) => {
          const timestamp = new Date(h.timestamp);
          const dateStr = timestamp.toLocaleDateString('en-IN', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
          });
          const timeStr = timestamp.toLocaleTimeString('en-IN', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });
          
          const status = (h.status || 'pending').replace(/_/g, ' ').toUpperCase();
          const notes = h.notes ? h.notes.trim() : 'No notes';
          
          let logEntry = `Call ${idx + 1}: [${dateStr} at ${timeStr}] Status: ${status} | Notes: ${notes}`;
          
          if (h.callback) {
            const cbTime = new Date(h.callback);
            const cbDateStr = cbTime.toLocaleDateString('en-IN', {
              day: '2-digit',
              month: 'short',
              year: 'numeric'
            });
            const cbTimeStr = cbTime.toLocaleTimeString('en-IN', {
              hour: '2-digit',
              minute: '2-digit',
              hour12: true
            });
            logEntry += ` | Callback Scheduled: ${cbDateStr} at ${cbTimeStr}`;
          }
          
          return logEntry;
        }).join(' || ');
        
        const currentStatus = (disp.status || 'pending').replace(/_/g, ' ').toUpperCase();
        
        let callbackInfo = 'Not Scheduled';
        if (disp.callback) {
          const cbTime = new Date(disp.callback);
          callbackInfo = cbTime.toLocaleDateString('en-IN', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
          }) + ' at ' + cbTime.toLocaleTimeString('en-IN', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });
        }
        
        let lastUpdated = 'Never';
        if (disp.lastUpdated) {
          const luTime = new Date(disp.lastUpdated);
          lastUpdated = luTime.toLocaleDateString('en-IN', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
          }) + ' at ' + luTime.toLocaleTimeString('en-IN', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });
        }
        
        // Create Customer Details string
        const customerDetails = [];
        
        // Add policy information
        if (item.policy) customerDetails.push(`Policy No - ${item.policy}`);
        if (item.plan) customerDetails.push(`Plan - ${item.plan.split(' - SI:')[0] || item.plan}`);
        if (item.sumInsured) customerDetails.push(`Sum Insured - ${item.sumInsured}`);
        if (item.amount) customerDetails.push(`Total Premium - ₹${item.amount.toLocaleString("en-IN")}`);
        if (item.addonCost && item.addonCost > 0) customerDetails.push(`Addon Cost - ₹${item.addonCost.toLocaleString("en-IN")}`);
        if (item.company) customerDetails.push(`Company - ${item.company}`);
        if (item.dob) customerDetails.push(`Age/DOB - ${item.dob}`);
        
        // Add custom fields
        if (item.mainCustomFields) {
          Object.entries(item.mainCustomFields).forEach(([key, value]) => {
            if (value) customerDetails.push(`${key} - ${value}`);
          });
        }
        
        // Add customer details from the item
        if (item.customerDetails) {
          const details = item.customerDetails.split(' | ');
          details.forEach(detail => {
            if (detail && detail.trim()) customerDetails.push(detail.trim());
          });
        }
        
        const customerDetailsStr = customerDetails.join('\n');
        
        // Create Utilities string
        const utilities = [];
        utilities.push(`Current Status - ${currentStatus}`);
        if (disp.notes) utilities.push(`Latest Notes - ${disp.notes}`);
        utilities.push(`Callback - ${callbackInfo}`);
        utilities.push(`Last Updated - ${lastUpdated}`);
        utilities.push(`Total Calls - ${callCount}`);
        utilities.push(`Disposition Log - ${dispositionLog || 'No interaction history available'}`);
        
        const utilitiesStr = utilities.join('\n');

        return [
          item.leadId,
          item.phone,
          item.name,
          item.date,
          customerDetailsStr,
          utilitiesStr
        ];
      });
      
      const csvRows = [headers, ...exportRows].map(row => {
        return row.map(cell => {
          const str = String(cell).replace(/"/g, '""');
          return `"${str}"`;
        }).join(',');
      }).join('\n');
      
      const blob = new Blob(['\uFEFF' + csvRows], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      
      const timestamp = new Date();
      const dateStr = timestamp.toISOString().split('T')[0];
      const fileName = `Insurance_CRM_Export_${dateStr}.csv`;
      
      link.setAttribute('href', url);
      link.setAttribute('download', fileName);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      const totalCalls = data.reduce((sum, item) => {
        const disp = getDisposition(item.policy);
        return sum + (disp.history || []).length;
      }, 0);
      
      alert(`✅ Export Successful!\n\n📊 Summary:\n• Total Leads: ${data.length}\n• Total Interactions: ${totalCalls}\n• File: ${fileName}\n\n✨ Export includes complete disposition logs with date, time, status, notes, and callbacks for each customer interaction.`);
    }

    function handleBackupRestore(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (!confirm('⚠️ Restore from backup?\n\nThis will replace ALL current data with the backup data.\n\nAre you sure you want to continue?')) {
        event.target.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const rows = text.split('\n').map(row => {
            const matches = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            return matches ? matches.map(cell => cell.replace(/^"|"$/g, '').trim()) : [];
          }).filter(row => row.length > 0);
          
          if (rows.length < 2) {
            alert('❌ Invalid backup file format');
            event.target.value = '';
            return;
          }
          
          const headers = rows[0].map(h => h.toLowerCase().trim());
          
          // Validate backup file headers
          const requiredHeaders = ['lead id', 'phone no', 'name', 'expiry date', 'customer details', 'utilities'];
          
          const hasAllHeaders = requiredHeaders.every(rh => 
            headers.some(h => h === rh)
          );
          
          if (!hasAllHeaders) {
            alert('❌ This is not a valid backup file.\n\nPlease upload a file exported from this system.');
            event.target.value = '';
            return;
          }
          
          const restoredData = [];
          const restoredDispositions = {};
          let successCount = 0;
          let errorCount = 0;
          
          for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (row.length < 10) continue;
            
            try {
              const getCell = (colName) => {
                const idx = headers.indexOf(colName.toLowerCase());
                return idx >= 0 && idx < row.length ? row[idx] : '';
              };
              
              const leadId = getCell('lead id');
              const phone = getCell('phone no').replace(/[^0-9]/g, '');
              const name = getCell('name');
              const expiryDate = getCell('expiry date');
              const customerDetailsStr = getCell('customer details');
              const utilitiesStr = getCell('utilities');
              
              if (!leadId || !name || !phone) {
                errorCount++;
                continue;
              }
              
              // Parse customer details
              let policy = '';
              let planName = '';
              let sumInsured = '';
              let premium = 0;
              let addonCost = 0;
              let company = '';
              let dob = '';
              let mainCustomFields = {};
              let customerDetails = '';
              
              if (customerDetailsStr) {
                const details = customerDetailsStr.split('\n');
                details.forEach(detail => {
                  if (detail.includes('Policy No - ')) {
                    policy = detail.replace('Policy No - ', '').trim();
                  } else if (detail.includes('Plan - ')) {
                    planName = detail.replace('Plan - ', '').trim();
                  } else if (detail.includes('Sum Insured - ')) {
                    sumInsured = detail.replace('Sum Insured - ', '').trim();
                  } else if (detail.includes('Total Premium - ₹')) {
                    premium = parseInt(detail.replace('Total Premium - ₹', '').replace(/,/g, '')) || 0;
                  } else if (detail.includes('Addon Cost - ₹')) {
                    addonCost = parseInt(detail.replace('Addon Cost - ₹', '').replace(/,/g, '')) || 0;
                  } else if (detail.includes('Company - ')) {
                    company = detail.replace('Company - ', '').trim();
                  } else if (detail.includes('Age/DOB - ')) {
                    dob = detail.replace('Age/DOB - ', '').trim();
                  } else if (detail.includes(' - ')) {
                    // Custom fields
                    const parts = detail.split(' - ');
                    if (parts.length >= 2) {
                      const key = parts[0].trim();
                      const value = parts.slice(1).join(' - ').trim();
                      mainCustomFields[key] = value;
                    }
                  }
                });
              }
              
              // Parse utilities
              let currentStatus = 'pending';
              let notes = '';
              let callbackStr = 'Not Scheduled';
              let lastUpdatedStr = 'Never';
              let dispositionLog = '';
              
              if (utilitiesStr) {
                const utilities = utilitiesStr.split('\n');
                utilities.forEach(util => {
                  if (util.includes('Current Status - ')) {
                    currentStatus = util.replace('Current Status - ', '').trim().toLowerCase().replace(/ /g, '_');
                  } else if (util.includes('Latest Notes - ')) {
                    notes = util.replace('Latest Notes - ', '').trim();
                  } else if (util.includes('Callback - ')) {
                    callbackStr = util.replace('Callback - ', '').trim();
                  } else if (util.includes('Last Updated - ')) {
                    lastUpdatedStr = util.replace('Last Updated - ', '').trim();
                  } else if (util.includes('Disposition Log - ')) {
                    dispositionLog = util.replace('Disposition Log - ', '').trim();
                  }
                });
              }
              
              // Restore customer data
              const item = {
                sno: restoredData.length + 1,
                leadId: leadId,
                policy: policy || `POL${Math.random().toString(36).substr(2, 8).toUpperCase()}`,
                name: name,
                phone: phone,
                date: expiryDate,
                plan: planName ? `${planName} - SI: ${sumInsured}` : 'Care Supreme',
                dob: dob,
                amount: premium,
                sumInsured: sumInsured,
                addonCost: addonCost,
                company: company,
                mainCustomFields: mainCustomFields,
                customerDetails: customerDetails
              };
              
              restoredData.push(item);
              
              // Restore disposition data
              const disposition = {
                status: currentStatus === 'pending' ? 'pending' : currentStatus,
                notes: notes && notes !== 'No notes added' && notes !== 'No notes' ? notes : '',
                callback: null,
                lastUpdated: null,
                history: []
              };
              
              // Parse callback
              if (callbackStr && callbackStr !== 'Not Scheduled') {
                try {
                  const cbParts = callbackStr.split(' at ');
                  if (cbParts.length === 2) {
                    const cbDate = new Date(cbParts[0] + ' ' + cbParts[1]);
                    if (!isNaN(cbDate.getTime())) {
                      disposition.callback = cbDate.toISOString();
                    }
                  }
                } catch (e) {
                  console.warn('Could not parse callback date:', e);
                }
              }
              
              // Parse last updated
              if (lastUpdatedStr && lastUpdatedStr !== 'Never') {
                try {
                  const luParts = lastUpdatedStr.split(' at ');
                  if (luParts.length === 2) {
                    const luDate = new Date(luParts[0] + ' ' + luParts[1]);
                    if (!isNaN(luDate.getTime())) {
                      disposition.lastUpdated = luDate.toISOString();
                    }
                  }
                } catch (e) {
                  console.warn('Could not parse last updated:', e);
                }
              }
              
              // Parse disposition history
              if (dispositionLog && dispositionLog !== 'No interaction history available') {
                const logEntries = dispositionLog.split(' || ');
                
                logEntries.forEach(entry => {
                  try {
                    // Format: Call 1: [05 Oct 2025 at 02:30 PM] Status: INTERESTED | Notes: text | Callback Scheduled: ...
                    const dateTimeMatch = entry.match(/\[(.*?)\]/);
                    const statusMatch = entry.match(/Status:\s*([^|]+)/);
                    const notesMatch = entry.match(/Notes:\s*([^|]+)/);
                    const callbackMatch = entry.match(/Callback Scheduled:\s*(.+)$/);
                    
                    if (dateTimeMatch && statusMatch) {
                      // Parse timestamp
                      let timestamp;
                      try {
                        const dtStr = dateTimeMatch[1].trim();
                        // Convert "05 Oct 2025 at 02:30 PM" to Date
                        const parts = dtStr.split(' at ');
                        if (parts.length === 2) {
                          const dateStr = parts[0];
                          const timeStr = parts[1];
                          timestamp = new Date(dateStr + ' ' + timeStr);
                        } else {
                          timestamp = new Date(dtStr);
                        }
                      } catch (e) {
                        timestamp = new Date();
                      }
                      
                      // Parse status
                      const status = statusMatch[1].trim().toLowerCase().replace(/ /g, '_');
                      
                      // Parse notes
                      let histNotes = '';
                      if (notesMatch) {
                        histNotes = notesMatch[1].trim();
                        if (histNotes === 'No notes') {
                          histNotes = '';
                        }
                      }
                      
                      // Create history entry
                      const histEntry = {
                        status: status,
                        notes: histNotes,
                        timestamp: timestamp.toISOString(),
                        callback: null
                      };
                      
                      // Parse callback if exists
                      if (callbackMatch) {
                        try {
                          const cbStr = callbackMatch[1].trim();
                          const cbParts = cbStr.split(' at ');
                          if (cbParts.length === 2) {
                            const cbDate = new Date(cbParts[0] + ' ' + cbParts[1]);
                            if (!isNaN(cbDate.getTime())) {
                              histEntry.callback = cbDate.toISOString();
                            }
                          }
                        } catch (e) {
                          console.warn('Could not parse callback in history:', e);
                        }
                      }
                      
                      disposition.history.push(histEntry);
                    }
                  } catch (e) {
                    console.warn('Error parsing history entry:', entry, e);
                  }
                });
              }
              
              restoredDispositions[leadId] = disposition;
              successCount++;
              
            } catch (err) {
              errorCount++;
              console.warn(`Error processing row ${i}:`, err);
            }
          }
          
          if (successCount === 0) {
            alert('❌ No valid data found in backup file');
            event.target.value = '';
            return;
          }
          
          // Apply restored data
          data.length = 0;
          data.push(...restoredData);
          
          dispositions = restoredDispositions;
          
          // Save to localStorage
          localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify(data));
          localStorage.setItem(STORAGE_KEY, JSON.stringify(dispositions));
          
          // Refresh UI
          renderCards();
          updateCounts();
          
          alert(`✅ Backup Restored Successfully!\n\n📊 Summary:\n• Leads Restored: ${successCount}\n• Total Interactions: ${Object.values(dispositions).reduce((sum, d) => sum + (d.history || []).length, 0)}\n${errorCount > 0 ? `\n⚠️ ${errorCount} rows had errors and were skipped.` : ''}\n\n✨ All customer data, dispositions, notes, callbacks, and complete history have been restored.`);
          
        } catch (error) {
          alert('❌ Error reading backup file: ' + error.message);
          console.error('Backup restore error:', error);
        }
      };
      
      reader.readAsText(file);
      event.target.value = '';
    }

    loadDispositions();
    renderCards();
    updateCounts();
    
    // Initialize mapping modal
    if (!document.getElementById('mappingModal')) {
      document.body.insertAdjacentHTML('beforeend', mappingModalHtml);
    }
  </script>
</body>
</html>